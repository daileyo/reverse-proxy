<VirtualHost *:80>
    ServerName      bitbucket
    ServerAlias     *.bitbucket

    ##  Application Specific Logs
    ##  ErrorLog ${APACHE_LOG_DIR}/bitbucket-error.log
    ##  CustomLog ${APACHE_LOG_DIR}/bitbucket-access.log combined
    ProxyPreserveHost   on
    AllowEncodedSlashes on
    RewriteEngine       on

    ## Port rewrite
    RewriteCond         %{SERVER_PORT} (.*)
    RewriteRule         (.*) - [E=my_server_port:%1]

    RewriteCond         %{REQUEST_SCHEME}
    RewriteRule         (.*) - [E=my_scheme:%1]

    RewriteCond         %{HTTP_HOST} (.*)
    RewriteRule         (.*) - [E=my_custom_host:%1]

    ## Now to put it all together
    RequestHeader       set host %{my_custom_host}e
    RequestHeader       set X-Forwarded-Port %{my_server_port}e
    RequestHeader       set X-Forwarded-Proto %{my_scheme}e
    RequestHeader       set X-Bitbucket-Override-Base-Url %{my_scheme}e/bitbucket/%{my_server_port}e
    ProxyPassReverseCookiePath /bitbucket/bitbucket

    ProxyPass           /bitbucket/ http://localhost:7990
    ProxyReverse        /bitbucket/ http://localhost:7990
</VirtualHost>
